#!/bin/bash

[[ -v installbase ]] || source /tmp/install/common.sh

get_users() {
  jq -r '.users | keys[]' "$installbase/config.json"
}

create_user() {
  local user_exists user=$1
  if [[ -e /home/$user ]]; then
    user_exists=1
  fi
  if [[ $user_exists ]]; then
    useradd -m -U -p "$(get_config .users.$user.password)" "$user"
  else
    useradd -U -p "$(get_config .users.$user.password)" "$user"
  fi
  if [[ $(get_config .users.$user.admin) = "true" ]]; then
    usermod -a -G wheel "$user"
  fi
  if [[ $user_exists ]]; then
    chown -R $user: /home/$user
    return 0
  fi
  local sshkey
  sshkey="$(get_config .users.$user.sshkey)"
  if [[ ${sshkey:-null} != "null" ]]; then
    mkdir -p /home/$user/.ssh
    chmod 700 /home/$user/.ssh
    echo "$sshkey" > /home/$user/.ssh/authorized_keys
    chmod 600 /home/$user/.ssh/authorized_keys
  fi
  mkdir -p /home/$user/.bashrc.d
  echo "alias ll='ls -lAZ --color=auto'" > /home/$user/.bashrc.d/aliases.sh
  chown -R $user: /home/$user
}

create_users() {
  local user users=$(get_users)
  for user in "$users"; do
    create_user $user
  done
}

set_root_pw() {
  local rootpw
  rootpw=$(get_config .rootpw)
  if [[ ${rootpw:-null} = "null" ]]; then
    return 0
  fi
  chmod 600 /etc/shadow
  sed -i -E "s@^root:\!unprovisioned:(.*)@root:$rootpw:\1@" /etc/shadow
  chmod 000 /etc/shadow
}

configure_sudoers() {
  chmod 640 /etc/sudoers
  sed -i -E 's/^%wheel\b.*/%wheel ALL=(ALL) NOPASSWD: ALL/' /etc/sudoers
  chmod 440 /etc/sudoers
}

configure_sdboot() {
  echo "timeout 30" >> /boot/efi/loader/loader.conf
}

configure_tpm_unlocking() {
  has_tpm || return 0
  local device=$(blkid --label pvroot)
  get_config .lukskey | tr -d '\n' > /tmp/temppass
  chmod 600 /tmp/temppass
  systemd-cryptenroll --wipe-slot tpm2 --tpm2-device auto --tpm2-pcrs "" --unlock-key-file /tmp/temppass $device || return 1
  dracut --quiet -f --kver $(uname -r)
}

do_postinstall() {
  run create_users || return
  run set_root_pw || return
  run configure_sudoers || return
  run configure_sdboot || return
  run configure_tpm_unlocking || return
}

return 2> /dev/null || {
  do_postinstall
}
