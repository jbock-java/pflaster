#!/bin/bash
#
# This runs very early. Before preinstall.
# Its job is to make sure that the partitions named in the profile config exist,
# are formatted and labeled, but not mounted yet.

[[ -v installbase ]] || source /var/tmp/install/common.sh

get_pvrootsize() {
  local disksize efisize=2044
  disksize=$(get_disksize)
  echo $(( disksize - efisize - 32 ))
}

print_parted_commands() {
  local efisize=2044
  local pvrootsize=$(get_pvrootsize)
  local pos=4
  echo "mklabel gpt"
  echo "mkpart EFISYS fat32 ${pos}MiB $(( pos + efisize ))MiB"
  (( pos += efisize ))
  echo "set 1 esp on"
  echo "mkpart pvroot ext4 ${pos}MiB $(( pos + pvrootsize ))MiB"
  (( pos += pvrootsize ))
}

wipe() {
  local disk part pvroot rootsize homesize label_home label_root label_efi volgs
  local pvrootsize=$(get_pvrootsize)
  vgchange -an
  label_home=$(get_config .storage.plain_lvm.partition.home) || return
  label_root=$(get_config .storage.plain_lvm.partition.root) || return
  label_efi=$(get_config .storage.plain_lvm.partition.efi) || return
  [[ $label_home = linux-* ]] || return $(error "invalid label: $label_home")
  [[ $label_root = linux-* ]] || return $(error "invalid label: $label_root")
  disk=$(get_disk) || return
  parted --script --align optimal $disk -- $(print_parted_commands) || return 
  mkfs.vfat -n $label_efi -F 32 $(by_partlabel EFISYS) || return
  pvroot=$(by_partlabel pvroot) || return
  volgs=$(vgs --noheadings | sed -E 's/^\s*\b(\S+)\b.*/\1/')
  if [[ $volgs = "linux" ]]; then
    vgremove -f linux
  fi
  pvcreate $pvroot || return
  vgcreate linux $pvroot || return
  (( rootsize = pvrootsize / 2 ))
  (( rootsize > 65536 && ( rootsize = 65536 ) ))
  (( rootsize < 8192 && ( rootsize = 8192 ) ))
  (( homesize = pvrootsize - rootsize - 32 ))
  (( homesize > 65536 && ( homesize = 65536 ) ))
  (( homesize >= 1024 )) || return
  lvcreate -L ${rootsize}M -n ${label_root#linux-} linux || return
  lvcreate -L ${homesize}M -n ${label_home#linux-} linux || return
  mkfs.ext4 -q -L $label_root /dev/mapper/$label_root <<< y || return
  mkfs.ext4 -q -L $label_home /dev/mapper/$label_home <<< y || return
}

only_format_root() {
  local efisys label_home label_root label_efi
  label_home=$(get_config .storage.plain_lvm.partition.home) || return
  label_root=$(get_config .storage.plain_lvm.partition.root) || return
  label_efi=$(get_config .storage.plain_lvm.partition.efi) || return
  [[ $label_home = linux-* ]] || return $(error "invalid label: $label_home")
  [[ $label_root = linux-* ]] || return $(error "invalid label: $label_root")
  efisys=$(blkid --label $label_efi) || return
  linuxroot=$(blkid --label $label_root) || return
  mkfs.ext4 -q -L $label_root $linuxroot <<< y || return
  mkfs.vfat -n $label_efi -F 32 $efisys || return
}

prepare_partitions() {
  local label_home REPLY
  vgchange -ay
  label_home=$(get_config .storage.plain_lvm.partition.home) || return
  if blkid --label $label_home &> /dev/null; then
    # todo: ask if wipe desired
    only_format_root
  else
    while true; do
      read -rp "Erase all data on $(get_disk)? [y/N] "
      [[ $REPLY =~ [yY] ]] && break
      [[ $REPLY =~ [nN] ]] && { echo "Installation halted." ; sleep inf ; }
    done
    wipe
  fi
}

return 2> /dev/null || {
  prepare_partitions
}
